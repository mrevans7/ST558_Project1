---
title: "ST558 Project 1"
author: Michael Evans
date: 6/5/2020
output: 
  rmarkdown::github_document:
    toc: true
---

```{r setup, include=FALSE}
library(tidyverse)
library(knitr)
library(DT)
library(httr)
library(jsonlite)
knitr::opts_chunk$set(echo = TRUE)
```

#JSON Data

## What is it?
JSON stands for Javascript Object Notation and is a way of storing data in an organized fashion that is easy to access. Generally regarded as a "lightweight data-interchange format", JSON data is great for both humans and machines, as it is both readable by humans and able to be parsed by machines. It was made popular by Douglas Crawford. This data type is built on collections of name/value pairs and an ordered list of values. 

## Where does it get used?
Since the two data types JSON data is built on are generally universal data structures, JSON data is considered language-independent. Because of this, many of the programming languages used today have ways of reading JSON data. JSON data is essentially just a text file, which makes it easy to send over servers. This feature has allowed it to be used frequently for transmitting information over the web. 

## Why is it a good way to store data?
Some of the previous features mentioned are the same reasons as to why JSON data is a good way of storing data. For starters, the "lightweight" feature of the data makes it extremely accessible. JSON data can be loaded quickly because of how "lightweight" it is, which has made it a great way to store data on the internet. It can be called and loaded quickly. 

Another reason that it is a good way of storing data is because it is easily compatible with so many modern programming languages. This means that many people working across different programs can still have easy access to the same datasets. 

That being said, there are also some limitations of JSON data. There is no way to add comments to JSON data. While JSON data is often readable, it can be difficult to understand the context of certain things without comments. This means that you often need to consult additional documentation to understand the data. Additionally, the language has no schema, which means that you could accidentally create data that you are not intending to create. On the other hand, the lack of schema is something that a lot of people like about JSON data, as it offers more flexibility.

## Packages Available
There are three major packages available in R for reading JSON data. These include `jsonlite`, `RJSONIO`, and  `rjson`. `jsonlite` is the newest package of the three and was developed based off of the `RJSONIO` package. While all of these packages are able to read JSON data, `jsonlite` offers the ability to return a data frame. Typically, `RJSONIO` and `rjson` return a list. 

`RJSONIO` was built as an alternative to the `rjson` package to offer a faster way to convert JSON data in R. Through updates, the `rjson` package is not just as fast, if not faster, than the `RJSONIO` package. The `RJSONIO` package also offers some additional options for customizing the JSON data that is being read into the program. 

## My Choice of Package
For this project, I am choosing to use the `jsonlite` package, as I like that it returns a data frame. The data frame is one of the most usable objects in R and will be helpful for doing exploratory data analysis after the data is read in. We will combine this package with the `httr` package to get JSON data. 

To read JSON data, we will first use the `GET()` function from `httr` to get the whatever information is present from the URL provided. Then, we will use the `content()` function from `httr` to retreive the content of the URL as a text file (use the option `as = "text` to do this). Finally, we will use the `fromJSON()` function from `jsonlite` to convert the JSON data to an R object. We will use the `flatten = T` option to automatically flatten the nested data frame into a non-nested data frame. 

## References
For more information on JSON data and the packages available in R, check out these resources that I consulted to gather the initial information:
1. https://www.json.org/json-en.html
2. https://developer.mozilla.org/en-US/docs/Learn/JavaScript/Objects/JSON
3. https://www.infoworld.com/article/3222851/what-is-json-a-better-format-for-data-exchange.html
4. https://www.r-bloggers.com/better-handling-of-json-data-in-r/
5. https://cran.r-project.org/web/packages/RJSONIO/index.html

# API Calls
```{r api.1, message = F}
#Franchise Function
franchise <- function(){
  full_url <- "https://records.nhl.com/site/api/franchise"
  get <- GET(url = full_url)
  content <- content(get, as = "text")
  nhl_data <- fromJSON(content, flatten = T)
  data <- nhl_data$data
  return(data)
}

#Get Data
franchise_data <- franchise()
```

```{r api.2, message = F}
#Franchise Team Totals Function
team_totals <- function(){
  full_url <- "https://records.nhl.com/site/api/franchise-team-totals"
  get <- GET(url = full_url)
  content <- content(get, as = "text")
  nhl_data <- fromJSON(content, flatten = T)
  data <- nhl_data$data
  return(data)
}

#Get Data
team_totals_data <- team_totals()
```

```{r api.3, message = F}
#Season Records for Franchise
season_franchise <- function(ID){
  ID <- as.character(ID)
  full_url <- paste0("https://records.nhl.com/site/api/franchise-season-records?cayenneExp=franchiseId=", ID) 
  get <- GET(url = full_url)
  content <- content(get, as = "text")
  nhl_data <- fromJSON(content, flatten = T)
  data <- nhl_data$data
  return(data)
}

#Get Data
season_franchise_data <- season_franchise("16")
```

```{r api.4, message = F}
#Goalie Records for Franchise
goalie_records <- function(ID){
  ID <- as.character(ID)
  full_url <- paste0("https://records.nhl.com/site/api/franchise-goalie-records?cayenneExp=franchiseId=", ID) 
  get <- GET(url = full_url)
  content <- content(get, as = "text")
  nhl_data <- fromJSON(content, flatten = T)
  data <- nhl_data$data
  return(data)
}

#Get Data
goalie_records_data <- goalie_records("16")
```

```{r api.5, message = F}
#Skater Records for Franchise
skater_records <- function(ID){
  ID <- as.character(ID)
  full_url <- paste0("https://records.nhl.com/site/api/franchise-skater-records?cayenneExp=franchiseId=", ID) 
  get <- GET(url = full_url)
  content <- content(get, as = "text")
  nhl_data <- fromJSON(content, flatten = T)
  data <- nhl_data$data
  return(data)
}

#Get Data
skater_records_data <- skater_records("16")
```

# Exploratory Data Analysis

## Contingency Tables
```{r numerical.1}
#Make frachise status a factor
team_totals_data$activeFranchise <- as.factor(team_totals_data$activeFranchise)

#Sum the number of wins and losses per each unique team
team_totals <- aggregate(list(team_totals_data$wins, team_totals_data$losses), by = list(team_totals_data$teamId, team_totals_data$activeFranchise, team_totals_data$teamName), sum)

#Rename the columns
names(team_totals) <- c("teamId", "activeFranchise", "teamName", "wins", "losses")

#Add variable to indictate is wins > losses
team_totals <- team_totals %>% mutate(win_greater_loss = ifelse(wins > losses, "More Wins", "More Losses"))

#Make variable a factor
team_totals$win_greater_loss <- as.factor(team_totals$win_greater_loss)

#Create Contingency Table
table.1 <- table(team_totals$activeFranchise, team_totals$win_greater_loss)

#Rename Columns
colnames(table.1) <- c("More Losses", "More Wins")

#Rename Rows
rownames(table.1) <- c("Inactive", "Active")

#Create Kable
kable(table.1, caption = "More Wins/Losses vs. Franchise Status")
```

```{r numerical.2}
#Create Contingency Table
table.2 <- table(skater_records_data$positionCode, skater_records_data$seasons)

#Create Kable
kable(table.2, caption = "Seasons Played vs. Position")
```

```{r numerical.3}
#Create Contingency Table
table.3 <- table(skater_records_data$activePlayer, skater_records_data$mostGoalsOneGame)

#Rename Rows
rownames(table.3) <- c("Inactive", "Active")

#Create Kable
kable(table.3, caption = "Most Goals in a Game vs. Player Status")
```

## Numerical Summaries

```{r numerical.4}
goalie_records_summary <- goalie_records_data %>% select(gamesPlayed, losses, wins, mostGoalsAgainstOneGame,
                                                         mostSavesOneGame)

#Get min, 25th quantile, mean, median, 75th quantile, and max
table.4 <- sapply(goalie_records_summary, min)
table.5 <- sapply(goalie_records_summary, quantile, probs = .25, na.rm=TRUE)
table.6 <- sapply(goalie_records_summary, mean, na.rm=TRUE)
table.7 <- sapply(goalie_records_summary, median, na.rm=TRUE)
table.8 <- sapply(goalie_records_summary, quantile, probs = .75, na.rm=TRUE)
table.9 <- sapply(goalie_records_summary, max, na.rm=TRUE)

#Combine into one table
table.10 <- rbind(table.4, table.5, table.6, table.7, table.8, table.9)

#Rename rows
rownames(table.10) <- c("Min.", "25th Percentile", "Mean", "Median", "75th Percentile", "Max.")

#Rename Columns
colnames(table.10) <- c("Games Played", "Losses", "Wins", "Most Goals Against (One Game)", 
                         "Most Saves (One Game)") 

kable(table.10, caption = "Summary for Goalie Statistics")

```

## Plots

```{r visuals.1}
#First Visual
visuals.1 <- ggplot(data = team_totals, aes(x = wins, y = losses))
visuals.1 + geom_point(aes(color = activeFranchise, shape = win_greater_loss)) +
  geom_smooth() + 
  labs(color = "Franchise Status", shape = "More Wins or Losses?") + 
  scale_color_manual(values = c("red", "blue"), labels = c("Inactive", "Active"))
```

```{r visuals.2, warning = F}
#Second Visual
visuals.2 <- ggplot(data = skater_records_data, aes(x = activePlayer, y = goals))
visuals.2 + geom_boxplot(aes(color = activePlayer)) +
  geom_jitter(aes(color = activePlayer), alpha = .2) +
  ylim(0, 75) +
  labs(title = "Boxplot for Goals Scored", color = "Player Status", x = "Player Status", y = "Goals") +
  scale_x_discrete(labels = c("Inactive", "Active")) +
  scale_color_discrete(labels = c("Inactive", "Active"))
```

```{r visuals.3, warning = F}
#Add variable to indictate if wins > 50
goalie_records_data <- goalie_records_data %>% mutate(win_50 = ifelse(wins > 50, "More Than 50", "Less Than 50"))

#Make variable a factor
goalie_records_data$win_50 <- as.factor(goalie_records_data$win_50)

visuals.3 <- ggplot(data = goalie_records_data, aes(x = shutouts))
visuals.3 + geom_histogram(aes(fill = win_50, y = ..density..), bins = 20) +
  geom_density() +
  labs(title = "Bar Plot for Shutouts", x = "Shutouts", y = "Density", fill = "Number of Wins")
```

```{r visuals.4, warning = F}
visuals.4 <- ggplot(data = skater_records_data, aes(x = seasons))
visuals.4 + geom_histogram(aes(fill = positionCode), bins = 15) +
  labs(title = "Bar Plot for Seasons Played", x = "Number of Seasons Played", y = "Count", fill = "Position")
```

```{r visuals.5, warning = F}
visuals.5 <- ggplot(data = skater_records_data, aes(x = mostGoalsOneGame))
visuals.5 + geom_histogram(aes(fill = activePlayer), bins = 5, position = "dodge") +
  labs(title = "Bar Plot for Most Goals in One Game", x = "Most Goals in One Game", y = "Count", 
       fill = "Player Status") +
  scale_fill_discrete(labels = c("Inactive", "Active"))
```

```{r visuals.6, warning = F}
visuals.6 <- ggplot(data = skater_records_data, aes(x = mostGoalsOneGame))
visuals.6 + geom_density(aes(fill = activePlayer), color = NA, size = 3, adjust = 5, alpha = .5) +
  labs(title = "Density Plot for Most Goals in One Game", x = "Most Goals in One Game", y = "Density", 
       fill = "Player Status") +
  scale_fill_discrete(labels = c("Inactive", "Active"))+
  guides(color = FALSE)
```




